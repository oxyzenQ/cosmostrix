name: T-800 - Release

'on':
  push:
    tags: ["v*"]

permissions:
  contents: write

jobs:
  build_packages:
    name: T-800 - Build packages (${{ matrix.platform }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            platform: linux-x86_64-v1
            profile: pro-linux-v1
            rustflags: "-C target-cpu=x86-64"
            build: linux-x86_64-v1
            checks: true
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            platform: linux-x86_64-v2
            profile: pro-linux-v2
            rustflags: "-C target-cpu=x86-64-v2"
            build: linux-x86_64-v2
            checks: false
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            platform: linux-x86_64-v3
            profile: pro-linux-v3
            rustflags: "-C target-cpu=x86-64-v3"
            build: linux-x86_64-v3
            checks: false
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            platform: linux-x86_64-v4
            profile: pro-linux-v4
            rustflags: "-C target-cpu=x86-64-v4"
            build: linux-x86_64-v4
            checks: false
          - os: ubuntu-24.04-arm
            target: aarch64-unknown-linux-gnu
            platform: linux-aarch64-native
            profile: pro
            rustflags: "-C target-cpu=native"
            build: linux-aarch64-native
            checks: false
          - os: macos-latest
            target: aarch64-apple-darwin
            platform: darwin-aarch64-native
            profile: pro-macos-aarch64-native
            rustflags: "-C target-cpu=native"
            build: darwin-aarch64-native
            checks: false
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            platform: windows-x86_64
            profile: pro-win-x86_64
            rustflags: "-C target-cpu=x86-64"
            build: windows-x86_64
            checks: false
          - os: windows-11-arm
            target: aarch64-pc-windows-msvc
            platform: windows-aarch64-native
            profile: pro
            rustflags: "-C target-cpu=native"
            build: windows-aarch64-native
            checks: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4.3.1
        with:
          fetch-depth: 0

      - name: Determine version
        id: ver
        shell: bash
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME}"

          TAG="${TAG## }"
          TAG="${TAG%% }"
          if [[ "${TAG}" != v* ]]; then
            TAG="v${TAG}"
          fi

          VERSION="${TAG#v}"
          {
            echo "tag=${TAG}"
            echo "version=${VERSION}"
          } >> "$GITHUB_OUTPUT"

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.81.0
          components: rustfmt, clippy

      - name: Setup cache
        uses: Swatinem/rust-cache@v2.8.2
        with:
          cache-on-failure: true

      - name: Set cargo build jobs (unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          JOBS="$(getconf _NPROCESSORS_ONLN 2>/dev/null || true)"
          if [[ -z "${JOBS}" ]]; then
            JOBS="$(nproc 2>/dev/null || true)"
          fi
          if [[ -z "${JOBS}" ]]; then
            JOBS="$(sysctl -n hw.ncpu 2>/dev/null || true)"
          fi
          if [[ -z "${JOBS}" ]]; then
            JOBS=2
          fi
          echo "CARGO_BUILD_JOBS=${JOBS}" >> "$GITHUB_ENV"

      - name: Set cargo build jobs (windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $jobs = $env:NUMBER_OF_PROCESSORS
          if (-not $jobs) { $jobs = 2 }
          "CARGO_BUILD_JOBS=$jobs" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

      - name: Add Rust target
        run: rustup target add ${{ matrix.target }}

      - name: Setup MSVC dev cmd (windows-amd64)
        if: matrix.target == 'x86_64-pc-windows-msvc'
        uses: ilammy/msvc-dev-cmd@v1.13.0
        with:
          arch: x64

      - name: Setup MSVC dev cmd (windows-aarch64)
        if: matrix.target == 'aarch64-pc-windows-msvc' && runner.arch == 'X64'
        uses: ilammy/msvc-dev-cmd@v1.13.0
        with:
          arch: amd64_arm64

      - name: Install Linux aarch64 linker
        if: matrix.target == 'aarch64-unknown-linux-gnu' && runner.arch == 'X64'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu

      - name: Install stable toolchain
        if: matrix.checks
        run: rustup toolchain install stable

      - name: Audit dependencies
        if: matrix.checks
        shell: bash
        run: |
          set -euo pipefail
          cargo +stable install cargo-audit --locked
          cargo +stable audit

      - name: Tests
        if: matrix.checks
        run: cargo test --all --locked

      - name: Build (debug)
        if: matrix.checks && runner.os != 'Windows'
        env:
          CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER: aarch64-linux-gnu-gcc
        run: cargo build --profile dev --locked --target ${{ matrix.target }} --jobs "${CARGO_BUILD_JOBS}"

      - name: Build (debug)
        if: matrix.checks && runner.os == 'Windows'
        shell: pwsh
        run: cargo build --profile dev --locked --target ${{ matrix.target }} --jobs "$env:CARGO_BUILD_JOBS"

      - name: Build (release) (aarch64 cross)
        if: matrix.target == 'aarch64-unknown-linux-gnu' && runner.arch == 'X64'
        env:
          CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER: aarch64-linux-gnu-gcc
          COSMOSTRIX_BUILD: ${{ matrix.build }}
          RUSTFLAGS: ${{ matrix.rustflags }}
        run: cargo build --profile ${{ matrix.profile }} --locked --target ${{ matrix.target }} --jobs "${CARGO_BUILD_JOBS}"

      - name: Build (release)
        if: (matrix.target != 'aarch64-unknown-linux-gnu' || runner.arch != 'X64') && runner.os != 'Windows'
        env:
          COSMOSTRIX_BUILD: ${{ matrix.build }}
          RUSTFLAGS: ${{ matrix.rustflags }}
        run: cargo build --profile ${{ matrix.profile }} --locked --target ${{ matrix.target }} --jobs "${CARGO_BUILD_JOBS}"

      - name: Build (release)
        if: (matrix.target != 'aarch64-unknown-linux-gnu' || runner.arch != 'X64') && runner.os == 'Windows'
        env:
          COSMOSTRIX_BUILD: ${{ matrix.build }}
          RUSTFLAGS: ${{ matrix.rustflags }}
        shell: pwsh
        run: cargo build --profile ${{ matrix.profile }} --locked --target ${{ matrix.target }} --jobs "$env:CARGO_BUILD_JOBS"

      - name: Verify build id
        if: runner.os != 'Windows' && (matrix.target != 'aarch64-unknown-linux-gnu' || runner.arch != 'X64')
        shell: bash
        run: |
          set -euo pipefail
          BIN="target/${{ matrix.target }}/${{ matrix.profile }}/cosmostrix"
          BUILD_ID="${{ matrix.build }}"

          if [[ "${BUILD_ID}" == *-v4 ]]; then
            echo "Skipping execution for ${BUILD_ID} (may require AVX-512); verifying embedded build id in binary"
            if command -v strings >/dev/null 2>&1; then
              strings "${BIN}" | grep -F "${BUILD_ID}"
            else
              grep -aF "${BUILD_ID}" "${BIN}"
            fi
          else
            OUT="$(${BIN} -i)"
            echo "${OUT}"
            echo "${OUT}" | grep -E "^(build|Build): ${BUILD_ID}( \\([0-9a-f]+\\))?$"
          fi

      - name: Verify build id
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $bin = "target/${{ matrix.target }}/${{ matrix.profile }}/cosmostrix.exe"
          $build = "${{ matrix.build }}"

          if ($build.EndsWith("-v4")) {
            Write-Host "Skipping execution for $build (may require AVX-512); verifying embedded build id in binary"
            $bytes = [System.IO.File]::ReadAllBytes($bin)
            $text = [System.Text.Encoding]::ASCII.GetString($bytes)
            if (-not $text.Contains($build)) {
              throw "Expected embedded build id '$build' in binary"
            }
          } else {
            $outLines = & $bin -i
            $out = $outLines -join "`n"
            $out
            $pat = "(?m)^(build|Build): " + [regex]::Escape($build) + "( \\([0-9a-f]+\\))?$"
            if ($out -notmatch $pat) {
              throw "Expected build id '$build' in cosmostrix -i output"
            }
          }

      - name: Format check
        if: matrix.checks
        run: cargo fmt --all -- --check

      - name: Dependency policy (cargo-deny)
        if: matrix.checks
        run: |
          cargo +stable install cargo-deny --locked
          cargo +stable deny check all

      - name: Clippy
        if: matrix.checks
        run: cargo clippy --locked --all-targets --all-features -- -D warnings

      - name: Package (.tar.gz)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          TAG="${{ steps.ver.outputs.tag }}"
          VERSION="${{ steps.ver.outputs.version }}"

          TARGET="${{ matrix.target }}"
          PLATFORM="${{ matrix.platform }}"

          PROFILE="${{ matrix.profile }}"

          OUTDIR="dist/cosmostrix-${VERSION}-${PLATFORM}"
          mkdir -p "$OUTDIR"
          cp -f "target/${TARGET}/${PROFILE}/cosmostrix" "$OUTDIR/"
          cp -f "README.md" "$OUTDIR/"
          cp -f "LICENSE" "$OUTDIR/"

          TARBALL="cosmostrix-bin-${TAG}-${PLATFORM}.tar.gz"
          tar -czf "dist/${TARBALL}" -C dist "cosmostrix-${VERSION}-${PLATFORM}"

          (
            cd dist
            if command -v sha512sum >/dev/null 2>&1; then
              sha512sum "${TARBALL}" > "${TARBALL}.sha512"
            else
              shasum -a 512 "${TARBALL}" > "${TARBALL}.sha512"
            fi
          )

      - name: Package (.zip)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $TAG = "${{ steps.ver.outputs.tag }}"
          $VERSION = "${{ steps.ver.outputs.version }}"
          $TARGET = "${{ matrix.target }}"
          $PLATFORM = "${{ matrix.platform }}"

          $PROFILE = "${{ matrix.profile }}"

          $outDir = "dist/cosmostrix-$VERSION-$PLATFORM"
          New-Item -ItemType Directory -Force -Path $outDir | Out-Null

          Copy-Item -Force "target/$TARGET/$PROFILE/cosmostrix.exe" "$outDir/"
          Copy-Item -Force "README.md" "$outDir/"
          Copy-Item -Force "LICENSE" "$outDir/"

          $zip = "cosmostrix-bin-$TAG-$PLATFORM.zip"
          if (Test-Path "dist/$zip") { Remove-Item -Force "dist/$zip" }
          Compress-Archive -Force -Path "$outDir/*" -DestinationPath "dist/$zip"

          $hash = (Get-FileHash -Algorithm SHA512 "dist/$zip").Hash.ToLower()
          "$hash  $zip" | Out-File -Encoding ascii "dist/$zip.sha512"

      - name: Upload artifact
        if: runner.os != 'Windows'
        uses: actions/upload-artifact@v4.6.2
        with:
          name: packages-${{ matrix.platform }}
          path: dist/*.tar.gz*
          if-no-files-found: error

      - name: Upload artifact
        if: runner.os == 'Windows'
        uses: actions/upload-artifact@v4.6.2
        with:
          name: packages-${{ matrix.platform }}
          path: dist/*.zip*
          if-no-files-found: error

  build_android:
    name: T-800 - Build packages (android-aarch64-native)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4.3.1
        with:
          fetch-depth: 0

      - name: Determine version
        id: ver
        shell: bash
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME}"

          TAG="${TAG## }"
          TAG="${TAG%% }"
          if [[ "${TAG}" != v* ]]; then
            TAG="v${TAG}"
          fi

          VERSION="${TAG#v}"
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.81.0

      - name: Setup cache
        uses: Swatinem/rust-cache@v2.8.2
        with:
          cache-on-failure: true

      - name: Set cargo build jobs
        shell: bash
        run: |
          set -euo pipefail
          JOBS="$(getconf _NPROCESSORS_ONLN 2>/dev/null || true)"
          if [[ -z "${JOBS}" ]]; then
            JOBS="$(nproc 2>/dev/null || true)"
          fi
          if [[ -z "${JOBS}" ]]; then
            JOBS="$(sysctl -n hw.ncpu 2>/dev/null || true)"
          fi
          if [[ -z "${JOBS}" ]]; then
            JOBS=2
          fi
          echo "CARGO_BUILD_JOBS=${JOBS}" >> "$GITHUB_ENV"

      - name: Setup Java
        uses: actions/setup-java@v4.8.0
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Android NDK
        id: ndk
        uses: nttld/setup-ndk@v1.5.0
        with:
          ndk-version: r26d

      - name: Add Rust target
        run: rustup target add aarch64-linux-android

      - name: Build (release, android-aarch64)
        shell: bash
        env:
          ANDROID_NDK_HOME: ${{ steps.ndk.outputs.ndk-path }}
          COSMOSTRIX_BUILD: android-aarch64-native
        run: |
          set -euo pipefail
          TARGET="aarch64-linux-android"

          TOOLCHAIN="${ANDROID_NDK_HOME}/toolchains/llvm/prebuilt/linux-x86_64"
          export CC_aarch64_linux_android="${TOOLCHAIN}/bin/aarch64-linux-android21-clang"
          export CARGO_TARGET_AARCH64_LINUX_ANDROID_LINKER="${CC_aarch64_linux_android}"

          cargo build --profile pro-android-aarch64 --locked --target "${TARGET}" --jobs "${CARGO_BUILD_JOBS}"

      - name: Package (.tar.gz)
        shell: bash
        run: |
          set -euo pipefail
          TAG="${{ steps.ver.outputs.tag }}"
          VERSION="${{ steps.ver.outputs.version }}"
          TARGET="aarch64-linux-android"
          PLATFORM="android-aarch64-native"

          PROFILE="pro-android-aarch64"

          OUTDIR="dist/cosmostrix-${VERSION}-${PLATFORM}"
          mkdir -p "$OUTDIR"
          cp -f "target/${TARGET}/${PROFILE}/cosmostrix" "$OUTDIR/"
          cp -f "README.md" "$OUTDIR/"
          cp -f "LICENSE" "$OUTDIR/"

          TARBALL="cosmostrix-bin-${TAG}-${PLATFORM}.tar.gz"
          tar -czf "dist/${TARBALL}" -C dist "cosmostrix-${VERSION}-${PLATFORM}"

          (
            cd dist
            if command -v sha512sum >/dev/null 2>&1; then
              sha512sum "${TARBALL}" > "${TARBALL}.sha512"
            else
              shasum -a 512 "${TARBALL}" > "${TARBALL}.sha512"
            fi
          )

      - name: Upload artifact
        uses: actions/upload-artifact@v4.6.2
        with:
          name: packages-android-aarch64-native
          path: dist/*.tar.gz*
          if-no-files-found: error

  publish_release:
    name: T-800 - Publish GitHub Release
    runs-on: ubuntu-latest
    needs: [build_packages, build_android]

    steps:
      - name: Checkout
        uses: actions/checkout@v4.3.1
        with:
          fetch-depth: 0

      - name: Determine version
        id: ver
        shell: bash
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME}"

          TAG="${TAG## }"
          TAG="${TAG%% }"
          if [[ "${TAG}" != v* ]]; then
            TAG="v${TAG}"
          fi

          VERSION="${TAG#v}"
          PRE="false"
          if [[ "${VERSION}" == *-* ]]; then
            SUFFIX="${VERSION#*-}"
            case "${SUFFIX}" in
              stable.*) PRE="false";;
              *) PRE="true";;
            esac
          fi

          {
            echo "tag=${TAG}"
            echo "version=${VERSION}"
            echo "prerelease=${PRE}"
          } >> "$GITHUB_OUTPUT"

      - name: Download artifacts
        uses: actions/download-artifact@v4.3.0
        with:
          path: dist

      - name: Prepare release notes
        id: prep
        shell: bash
        run: |
          set -euo pipefail
          TAG="${{ steps.ver.outputs.tag }}"
          VERSION="${{ steps.ver.outputs.version }}"
          PRERELEASE="${{ steps.ver.outputs.prerelease }}"
          REPO="${GITHUB_REPOSITORY}"

          # Find previous STABLE tag (skip pre-releases for stable comparison)
          if [ "${PRERELEASE}" = "false" ]; then
            PREV_TAG=$(git tag --list 'v*' --sort=-creatordate | \
              grep -v "^${TAG}$" | \
              grep -v -E -- '-(alpha|beta|rc)\.' | \
              head -n 1 || true)
          else
            PREV_TAG=$(git tag --list 'v*' --sort=-creatordate | \
              grep -v "^${TAG}$" | \
              head -n 1 || true)
          fi

          if [ -n "$PREV_TAG" ]; then
            RANGE="${PREV_TAG}..${TAG}"
            CHANGELOG_URL="https://github.com/${REPO}/compare/${PREV_TAG}...${TAG}"
            CHANGELOG_LABEL="${PREV_TAG}...${TAG}"
          else
            RANGE="${TAG}"
            CHANGELOG_URL="https://github.com/${REPO}/releases/tag/${TAG}"
            CHANGELOG_LABEL="${TAG}"
          fi

          # Categorize commits
          FEATURES=$(git log --no-merges --pretty=format:'- %s (%h)' "${RANGE}" | grep "^- feat" || true)
          FIXES=$(git log --no-merges --pretty=format:'- %s (%h)' "${RANGE}" | grep "^- fix" || true)
          CHORES=$(git log --no-merges --pretty=format:'- %s (%h)' "${RANGE}" | grep "^- chore" || true)
          OTHERS=$(git log --no-merges --pretty=format:'- %s (%h)' "${RANGE}" | grep -v "^- feat" | grep -v "^- fix" | grep -v "^- chore" || true)

          if [ "${PRERELEASE}" = "true" ]; then
            RELEASE_BADGE="> **Pre-release** â€¢ Experimental features ahead"
            KNOWN_ISSUES="âš ï¸ This is a pre-release. Report bugs via [Issues](https://github.com/${REPO}/issues)."
            WHATS_NEW="A pre-release build with upcoming changes for testing."
          else
            RELEASE_BADGE="> **Stable Release** â€¢ Production ready"
            KNOWN_ISSUES="ðŸ› Report bugs via [Issues](https://github.com/${REPO}/issues)."
            WHATS_NEW="A stable release including all improvements from previous versions."
          fi

          {
            echo "## ðŸŒŒ Cosmostrix ${TAG}"
            echo
            echo "${RELEASE_BADGE}"
            echo
            echo "### âœ¨ What's New"
            echo
            echo "${WHATS_NEW}"
            echo

            if [ -n "$FEATURES" ]; then
              echo "### ðŸŽ‰ New Features"
              echo
              echo "$FEATURES"
              echo
            fi

            if [ -n "$FIXES" ]; then
              echo "### ðŸ› Bug Fixes"
              echo
              echo "$FIXES"
              echo
            fi

            if [ -n "$CHORES" ]; then
              echo "### ðŸ”§ Maintenance"
              echo
              echo "$CHORES"
              echo
            fi

            if [ -n "$OTHERS" ]; then
              echo "### ðŸ“¦ Other Changes"
              echo
              echo "$OTHERS"
              echo
            fi

            echo "### ðŸ“¥ Installation"
            echo
            echo '```bash'
            echo '# Quick install (Linux x86_64)'
            echo "curl -L https://github.com/${REPO}/releases/download/${TAG}/cosmostrix-bin-${TAG}-linux-x86_64-v1.tar.gz | tar -xzf -"
            echo
            echo '# Quick install (macOS Apple Silicon)'
            echo "curl -L https://github.com/${REPO}/releases/download/${TAG}/cosmostrix-bin-${TAG}-darwin-aarch64-native.tar.gz | tar -xzf -"
            echo
            echo '# Quick install (Windows x86_64) (PowerShell)'
            echo "curl.exe -L -o cosmostrix.zip https://github.com/${REPO}/releases/download/${TAG}/cosmostrix-bin-${TAG}-windows-x86_64.zip"
            echo 'Expand-Archive -Force cosmostrix.zip .'
            echo
            echo '# Or download your platform-specific package from the assets below'
            echo '```'
            echo
            echo "### ðŸ› Feedback"
            echo
            echo "${KNOWN_ISSUES}"
            echo
            echo "---"
            echo
            echo "**Full Changelog**: [\`${CHANGELOG_LABEL}\`](${CHANGELOG_URL})"
          } > release-notes.md

          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2.5.0
        with:
          tag_name: ${{ steps.prep.outputs.tag }}
          name: cosmostrix ${{ steps.prep.outputs.version }}
          draft: false
          prerelease: ${{ steps.ver.outputs.prerelease }}
          make_latest: ${{ steps.ver.outputs.prerelease != 'true' }}
          body_path: release-notes.md
          files: |
            dist/**/*.tar.gz
            dist/**/*.tar.gz.sha512
            dist/**/*.zip
            dist/**/*.zip.sha512

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
