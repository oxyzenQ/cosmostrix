# =============================================================================
# AUTO DEPENDENCY UPDATE - T-800
# =============================================================================
# Features:
# - Daily auto-update dependencies (08:00 WIB / 01:00 UTC)
# - Self-healing: auto-updates GitHub Actions in workflows
# - Security audit before commit
# - Test validation
# - Powered by T-800 automation

name: "T-800 - Auto Update Dependencies"

'on':
  schedule:
    - cron: "0 1 * * *"  # 08:00 WIB daily
  workflow_dispatch:
    inputs:
      strategy:
        description: "How to publish updates"
        type: choice
        options:
          - direct
          - pr
        default: direct
      force_update:
        description: "Continue even if tests fail"
        type: boolean
        default: false
      update_workflows:
        description: "Also update GitHub Actions versions"
        type: boolean
        default: true

permissions:
  contents: write
  actions: read
  pull-requests: write

env:
  CARGO_TERM_COLOR: always
  BOT_TOKEN: ${{ secrets.T800_TOKEN || secrets.NEBULA_TOKEN }}
  UPDATE_STRATEGY: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.strategy || 'direct' }}
  FORCE_UPDATE: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.force_update || 'false' }}
  UPDATE_WORKFLOWS: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.update_workflows || 'true' }}

jobs:
  auto-update:
    name: "ğŸ¤– T-800 - Dependency & Workflow Update"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ env.BOT_TOKEN }}
          fetch-depth: 0

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.81.0
          components: rustfmt, clippy

      - name: Install stable toolchain
        run: rustup toolchain install stable

      - name: Setup cache
        uses: Swatinem/rust-cache@v2.8.2
        with:
          cache-on-failure: true

      # =============================================================================
      # SELF-HEALING: AUTO-UPDATE GITHUB ACTIONS VERSIONS
      # =============================================================================
      - name: ğŸ¤– Self-Update GitHub Actions
        if: env.UPDATE_WORKFLOWS == 'true'
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ” Scanning for outdated GitHub Actions..."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          UPDATED=false
          UPDATES_LOG=""
          ACTIONS_UPDATE_LOG="${RUNNER_TEMP}/actions-updates.log"
          : > "${ACTIONS_UPDATE_LOG}"

          AUTH_HEADER="Authorization: Bearer ${BOT_TOKEN}"

          for workflow in .github/workflows/*.yml .github/workflows/*.yaml; do
            [ -f "$workflow" ] || continue

            echo ""
            echo "ğŸ“„ Checking: $workflow"

            while read -r action_with_ver; do
              ACTION="${action_with_ver%@*}"
              CURRENT_VER="${action_with_ver#*@}"

              [[ "$CURRENT_VER" =~ ^v[0-9] ]] || continue

              echo "  ğŸ” Checking: $ACTION @ $CURRENT_VER"

              if [[ "$ACTION" == */* ]]; then
                LATEST_TAG=$(curl -s -H "$AUTH_HEADER" "https://api.github.com/repos/$ACTION/releases/latest" | grep -oP '"tag_name":\s*"\K[^"]+' || echo "")

                if [ -z "$LATEST_TAG" ]; then
                  LATEST_TAG=$(curl -s -H "$AUTH_HEADER" "https://api.github.com/repos/$ACTION/tags" | grep -oP '"name":\s*"v\K[0-9]+(\.[0-9]+)*' | head -n1)
                  [ -n "$LATEST_TAG" ] && LATEST_TAG="v$LATEST_TAG"
                fi

                if [ -n "$LATEST_TAG" ] && [ "$LATEST_TAG" != "$CURRENT_VER" ]; then
                  CURRENT_MAJOR="${CURRENT_VER#v}"
                  CURRENT_MAJOR="${CURRENT_MAJOR%%.*}"
                  LATEST_MAJOR="${LATEST_TAG#v}"
                  LATEST_MAJOR="${LATEST_MAJOR%%.*}"

                  if [ "$CURRENT_MAJOR" == "$LATEST_MAJOR" ]; then
                    echo "    âœ¨ Update available: $CURRENT_VER â†’ $LATEST_TAG"

                    sed -i "s|$ACTION@$CURRENT_VER|$ACTION@$LATEST_TAG|g" "$workflow"

                    UPDATED=true
                    UPDATES_LOG="${UPDATES_LOG}\n  - $ACTION: $CURRENT_VER â†’ $LATEST_TAG"
                    echo "$ACTION: $CURRENT_VER -> $LATEST_TAG" >> "${ACTIONS_UPDATE_LOG}"
                  else
                    echo "    âš ï¸  Major version change detected ($CURRENT_VER â†’ $LATEST_TAG), skipping"
                  fi
                else
                  echo "    âœ… Already up-to-date"
                fi
              fi
            done < <(grep -oP 'uses:\s+\K[^@\s]+@v[0-9]+(\.[0-9]+)*' "$workflow" | sort -u)
          done

          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          echo "actions_update_log=${ACTIONS_UPDATE_LOG}" >> "$GITHUB_ENV"

          if [ "$UPDATED" = true ]; then
            echo "âœ¨ GitHub Actions updated successfully!"
            echo -e "$UPDATES_LOG"
            echo "workflows_updated=true" >> "$GITHUB_ENV"
          else
            echo "âœ… All GitHub Actions are up-to-date"
            echo "workflows_updated=false" >> "$GITHUB_ENV"
          fi

          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      # =============================================================================
      # RUST DEPENDENCIES UPDATE
      # =============================================================================
      - name: Check current versions
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“¦ Current Rust dependency versions:"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          cargo tree --depth 1 || true
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: Baseline security audit (pre-update)
        id: pre_audit
        shell: bash
        run: |
          set -euo pipefail
          echo "ğŸ”’ Running baseline security audit (pre-update)..."

          cargo +stable install cargo-audit --locked

          if cargo +stable audit; then
            echo "vulnerable=false" >> "$GITHUB_OUTPUT"
          else
            echo "vulnerable=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Update dependencies
        id: update_deps
        run: |
          echo "ğŸ”„ Updating Cargo.lock..."
          CARGO_UPDATE_LOG="${RUNNER_TEMP}/cargo-update.log"
          echo "cargo_update_log=${CARGO_UPDATE_LOG}" >> "$GITHUB_ENV"
          cargo update 2>&1 | tee "${CARGO_UPDATE_LOG}"

          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“¦ Updated dependency tree:"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          cargo tree --depth 1 || true
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: Security audit
        id: post_audit
        run: |
          echo "ğŸ”’ Running security audit..."
          cargo +stable audit

      - name: Dependency policy (cargo-deny)
        id: deny
        run: |
          echo "ğŸ›¡ï¸  Checking dependency policies..."
          cargo +stable install cargo-deny --locked
          cargo +stable deny check all

      - name: Format check
        id: fmt
        run: |
          echo "ğŸ¨ Checking code formatting..."
          cargo fmt --all -- --check

      - name: Build project
        id: build
        run: |
          echo "ğŸ”¨ Building with updated dependencies..."
          cargo build --profile dev --locked
          cargo build --profile release --locked

          echo ""
          echo "âœ… Build successful with updated deps"

      - name: Run tests
        id: tests
        run: |
          echo "ğŸ§ª Running test suite..."
          cargo test --all --locked

          echo ""
          echo "âœ… All tests passed"
        continue-on-error: ${{ env.FORCE_UPDATE == 'true' }}

      - name: Quick clippy check
        id: clippy
        run: |
          echo "ğŸ” Running clippy sanity check..."
          cargo clippy --locked --all-targets --all-features -- -D warnings

      - name: Configure Git (T-800 identity)
        run: |
          echo "âš™ï¸  Configuring Git as T-800..."
          git config --global user.name "oxyzenQ[T-800]"
          git config --global user.email "${{ secrets.GIT_EMAIL }}"

          git config --global commit.gpgsign false
          git config --global tag.gpgsign false
          git config --local commit.gpgsign false
          git config --local tag.gpgsign false

          echo "âœ… Git configured with T-800 identity"

      - name: Check for changes
        id: check_changes
        run: |
          if [[ -z "$(git status --porcelain)" ]]; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "âœ… No updates needed"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "ğŸ“ Updates detected"
            echo ""
            echo "Changed files:"
            git status --porcelain
            echo ""
            echo "Diff stat:"
            git diff --stat
          fi

      - name: Generate commit message
        id: commit_msg
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          WORKFLOW_UPDATED="${{ env.workflows_updated }}"
          ACTIONS_UPDATE_LOG="${{ env.actions_update_log }}"

          PRE_AUDIT_VULNERABLE="${{ steps.pre_audit.outputs.vulnerable }}"
          SECURITY_UPDATE="false"
          if [ "${PRE_AUDIT_VULNERABLE}" = "true" ]; then
            SECURITY_UPDATE="true"
          fi

          CARGO_UPDATE_LOG="${{ env.cargo_update_log }}"
          UPDATES_COUNT="0"
          if [ -n "${CARGO_UPDATE_LOG}" ] && [ -f "${CARGO_UPDATE_LOG}" ]; then
            UPDATES_COUNT="$(grep -cE '^[[:space:]]*(Updating|Downgrading)[[:space:]]+' "${CARGO_UPDATE_LOG}")"
          fi

          BREAKING_UPDATE="false"
          if [ -n "${CARGO_UPDATE_LOG}" ] && [ -f "${CARGO_UPDATE_LOG}" ]; then
            while IFS= read -r line; do
              if [[ "${line}" =~ ^[[:space:]]*(Updating|Downgrading)[[:space:]]+[^[:space:]]+[[:space:]]+v([0-9]+)\.([0-9]+)\.([0-9]+)[[:space:]]+\-\>[[:space:]]+v([0-9]+)\.([0-9]+)\.([0-9]+) ]]; then
                OLD_MAJOR="${BASH_REMATCH[2]}"
                OLD_MINOR="${BASH_REMATCH[3]}"
                NEW_MAJOR="${BASH_REMATCH[5]}"
                NEW_MINOR="${BASH_REMATCH[6]}"

                if [ "${OLD_MAJOR}" != "${NEW_MAJOR}" ]; then
                  BREAKING_UPDATE="true"
                  break
                fi

                if [ "${OLD_MAJOR}" = "0" ] && [ "${OLD_MINOR}" != "${NEW_MINOR}" ]; then
                  BREAKING_UPDATE="true"
                  break
                fi
              fi
            done < "${CARGO_UPDATE_LOG}"
          fi

          LABELS=$'dependencies\nautomated\nğŸ¤– bot'
          if [ "${SECURITY_UPDATE}" = "true" ]; then
            LABELS+=$'\nsecurity'
          fi
          if [ "${BREAKING_UPDATE}" = "true" ]; then
            LABELS+=$'\nbreaking'
          fi
          if [ "${SECURITY_UPDATE}" != "true" ] && [ "${BREAKING_UPDATE}" != "true" ]; then
            LABELS+=$'\nenhancement'
          fi

          {
            echo "yamllabels<<EOF"
            printf "%s\n" "${LABELS}"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

          if [ "${SECURITY_UPDATE}" = "true" ] && [ "${WORKFLOW_UPDATED}" = "true" ]; then
            TITLE="fix(security): T-800 patches vulnerable deps + refreshes workflows"
          elif [ "${SECURITY_UPDATE}" = "true" ]; then
            TITLE="fix(security): T-800 patches vulnerable dependencies"
          elif [ "${BREAKING_UPDATE}" = "true" ] && [ "${WORKFLOW_UPDATED}" = "true" ]; then
            TITLE="chore(deps)!: T-800 recalibrates dependencies & workflows"
          elif [ "${BREAKING_UPDATE}" = "true" ]; then
            TITLE="chore(deps)!: T-800 dependency recalibration"
          elif [ "${WORKFLOW_UPDATED}" = "true" ]; then
            TITLE="chore: T-800 recalibrates dependencies & workflows"
          else
            TITLE="chore(deps): T-800 dependency recalibration"
          fi

          TESTS_OUTCOME="${{ steps.tests.outcome }}"
          TESTS_STATUS="âœ… passed"
          if [ "${TESTS_OUTCOME}" != "success" ]; then
            if [ "${FORCE_UPDATE}" = "true" ]; then
              TESTS_STATUS="âš ï¸ failed (forced)"
            else
              TESTS_STATUS="âŒ failed"
            fi
          fi

          BASELINE_SECURITY_STATUS="âœ… clean"
          if [ "${SECURITY_UPDATE}" = "true" ]; then
            BASELINE_SECURITY_STATUS="âš ï¸ advisories found"
          fi

          BODY="ğŸ¤– Automated update by T-800"
          BODY+=$'\n\n'"## Summary"
          BODY+=$'\n'"- ğŸ“¦ Rust dependencies updated via \`cargo update\` (${UPDATES_COUNT} changes)"
          BODY+=$'\n'"- ğŸ” Security baseline (pre-update): ${BASELINE_SECURITY_STATUS}"
          BODY+=$'\n'"- ğŸ”’ Security audit (post-update): âœ… passed"
          BODY+=$'\n'"- ğŸ›¡ï¸ Dependency policy (cargo-deny): âœ… passed"
          BODY+=$'\n'"- ğŸ¨ Formatting (cargo fmt): âœ… passed"
          BODY+=$'\n'"- ğŸ”¨ Build (dev + release): âœ… passed"
          BODY+=$'\n'"- ğŸ§ª Tests: ${TESTS_STATUS}"
          BODY+=$'\n'"- ğŸ” Clippy: âœ… passed"

          if [ "${WORKFLOW_UPDATED}" = "true" ] && [ -n "${ACTIONS_UPDATE_LOG}" ] && [ -s "${ACTIONS_UPDATE_LOG}" ]; then
            BODY="${BODY}"$'\n\n'"## GitHub Actions updated"
            while IFS= read -r line; do
              [ -n "${line}" ] || continue
              BODY="${BODY}"$'\n'"- ${line}"
            done < "${ACTIONS_UPDATE_LOG}"
          fi

          if [ -n "${CARGO_UPDATE_LOG}" ] && [ -f "${CARGO_UPDATE_LOG}" ]; then
            UPDATES_SECTION=false
            while IFS= read -r line; do
              [ -n "${line}" ] || continue

              if [ "${UPDATES_SECTION}" != "true" ]; then
                BODY="${BODY}"$'\n\n'"## Dependency updates (top 25)"
                UPDATES_SECTION=true
              fi

              BODY="${BODY}"$'\n'"- ${line}"
            done < <(grep -E '^[[:space:]]*(Updating|Downgrading)[[:space:]]+' "${CARGO_UPDATE_LOG}" | head -n 25 | sed -E 's/^[[:space:]]+//')
          fi

          if [ "${SECURITY_UPDATE}" = "true" ]; then
            BODY="${BODY}"$'\n\n'"## Security"$'\n'"- Baseline audit found advisories before the update"
          fi

          if [ "${BREAKING_UPDATE}" = "true" ]; then
            BODY="${BODY}"$'\n\n'"## Breaking change risk"$'\n'"- Detected a major (or 0.x minor) version jump in Cargo.lock"
          fi

          CO_AUTHOR_NAME="oxyzenQ"
          CO_AUTHOR_EMAIL="${{ secrets.GIT_EMAIL }}"
          CO_AUTHOR_TRAILER="Co-authored-by: ${CO_AUTHOR_NAME} <${CO_AUTHOR_EMAIL}>"

          COMMIT_BODY="${BODY}"$'\n\n'"${CO_AUTHOR_TRAILER}"

          {
            echo "title=$TITLE"
            echo "body<<EOF"
            echo "$BODY"
            echo "EOF"
            echo "commit_body<<EOF"
            echo "$COMMIT_BODY"
            echo "EOF"
            echo "commit_message<<EOF"
            echo "$TITLE"
            echo ""
            echo "$COMMIT_BODY"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Commit and push changes
        if: steps.check_changes.outputs.changed == 'true' && env.UPDATE_STRATEGY == 'direct'
        run: |
          git add -A

          git commit -s \
            -m "${{ steps.commit_msg.outputs.title }}" \
            -m "${{ steps.commit_msg.outputs.commit_body }}"

          git push origin main

          echo ""
          echo "âœ… Updates pushed to main"
          echo "ğŸ“ Commit: $(git rev-parse HEAD)"

      - name: Create pull request
        id: cpr
        if: steps.check_changes.outputs.changed == 'true' && env.UPDATE_STRATEGY == 'pr'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ env.BOT_TOKEN }}
          commit-message: "${{ steps.commit_msg.outputs.commit_message }}"
          title: "${{ steps.commit_msg.outputs.title }}"
          body: "${{ steps.commit_msg.outputs.body }}"
          branch: bot/t-800-auto-update
          delete-branch: true
          signoff: true
          labels: ${{ steps.commit_msg.outputs.yamllabels }}
          committer: oxyzenQ[T-800] <${{ secrets.GIT_EMAIL }}>
          author: oxyzenQ[T-800] <${{ secrets.GIT_EMAIL }}>

      - name: Summary
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ¤– T-800 - UPDATE SUMMARY"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Strategy: ${{ env.UPDATE_STRATEGY }}"
          echo "Workflow Updates: ${{ env.UPDATE_WORKFLOWS }}"
          echo ""

          if [ "${{ steps.check_changes.outputs.changed }}" == "true" ]; then
            echo "âœ¨ Updates Applied:"

            if [ "${{ env.workflows_updated }}" == "true" ]; then
              echo "  - ğŸ”„ GitHub Actions updated"
            fi
            echo "  - ğŸ“¦ Rust dependencies updated"
            echo "  - ğŸ”’ Security audit passed"
            if [ "${{ steps.tests.outcome }}" == "success" ]; then
              echo "  - ğŸ§ª Tests passed"
            else
              if [ "${{ env.FORCE_UPDATE }}" == "true" ]; then
                echo "  - ğŸ§ª Tests failed (forced)"
              else
                echo "  - ğŸ§ª Tests failed"
              fi
            fi
            echo ""

            if [ "${{ env.UPDATE_STRATEGY }}" == "direct" ]; then
              echo "âœ… Changes pushed to main"
              echo "ğŸ“ Commit: $(git rev-parse HEAD)"
            else
              echo "âœ… Pull request created"
              echo "ğŸ”— PR: ${{ steps.cpr.outputs.pull-request-url }}"
            fi
          else
            echo "âœ… No updates needed - everything is current!"
          fi

          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "â° Next run: 01:00 UTC (08:00 WIB)"
          echo "ğŸš€ Manual trigger: Actions â†’ Auto Update Dependencies"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
