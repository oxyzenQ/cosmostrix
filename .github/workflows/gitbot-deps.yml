# =============================================================================
# AUTO DEPENDENCY UPDATE - NEBULA
# =============================================================================
# Features:
# - Daily auto-update dependencies (08:00 WIB / 01:00 UTC)
# - Self-healing: auto-updates GitHub Actions in workflows
# - Security audit before commit
# - Test validation
# - Powered by Nebula automation

name: "Auto Update Dependencies"

on:
  schedule:
    - cron: "0 1 * * *"  # 08:00 WIB daily
  workflow_dispatch:
    inputs:
      strategy:
        description: "How to publish updates"
        type: choice
        options:
          - direct
          - pr
        default: direct
      force_update:
        description: "Continue even if tests fail"
        type: boolean
        default: false
      update_workflows:
        description: "Also update GitHub Actions versions"
        type: boolean
        default: true

permissions:
  contents: write
  actions: read
  pull-requests: write

env:
  CARGO_TERM_COLOR: always
  UPDATE_STRATEGY: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.strategy || 'direct' }}
  FORCE_UPDATE: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.force_update || 'false' }}
  UPDATE_WORKFLOWS: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.update_workflows || 'true' }}

jobs:
  auto-update:
    name: "ğŸŒŒ Nebula - Dependency & Workflow Update"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.NEBULA_TOKEN }}  # Personal Access Token dari owner
          fetch-depth: 0

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.81.0
          components: rustfmt, clippy

      - name: Install stable toolchain
        run: rustup toolchain install stable

      - name: Setup cache
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: true

      # =============================================================================
      # SELF-HEALING: AUTO-UPDATE GITHUB ACTIONS VERSIONS
      # =============================================================================
      - name: ğŸ¤– Self-Update GitHub Actions
        if: env.UPDATE_WORKFLOWS == 'true'
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ” Scanning for outdated GitHub Actions..."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          UPDATED=false
          UPDATES_LOG=""

          # Find all workflow files
          for workflow in .github/workflows/*.yml .github/workflows/*.yaml; do
            [ -f "$workflow" ] || continue

            echo ""
            echo "ğŸ“„ Checking: $workflow"

            # Extract all action versions (format: uses: org/action@vX or @vX.Y.Z)
            grep -oP 'uses:\s+\K[^@\s]+@v[0-9]+(\.[0-9]+)*' "$workflow" | sort -u | while read -r action_with_ver; do
              ACTION="${action_with_ver%@*}"
              CURRENT_VER="${action_with_ver#*@}"

              # Skip if not a versioned action
              [[ "$CURRENT_VER" =~ ^v[0-9] ]] || continue

              echo "  ğŸ” Checking: $ACTION @ $CURRENT_VER"

              # Fetch latest version from GitHub API
              if [[ "$ACTION" == */* ]]; then
                LATEST_TAG=$(curl -s "https://api.github.com/repos/$ACTION/releases/latest" | grep -oP '"tag_name":\s*"\K[^"]+' || echo "")

                # Fallback: check tags if no releases
                if [ -z "$LATEST_TAG" ]; then
                  LATEST_TAG=$(curl -s "https://api.github.com/repos/$ACTION/tags" | grep -oP '"name":\s*"v\K[0-9]+(\.[0-9]+)*' | head -n1)
                  [ -n "$LATEST_TAG" ] && LATEST_TAG="v$LATEST_TAG"
                fi

                if [ -n "$LATEST_TAG" ] && [ "$LATEST_TAG" != "$CURRENT_VER" ]; then
                  # Check if it's a major version update
                  CURRENT_MAJOR="${CURRENT_VER#v}"
                  CURRENT_MAJOR="${CURRENT_MAJOR%%.*}"
                  LATEST_MAJOR="${LATEST_TAG#v}"
                  LATEST_MAJOR="${LATEST_MAJOR%%.*}"

                  # Only update if same major version (avoid breaking changes)
                  if [ "$CURRENT_MAJOR" == "$LATEST_MAJOR" ]; then
                    echo "    âœ¨ Update available: $CURRENT_VER â†’ $LATEST_TAG"

                    # Perform update
                    sed -i "s|$ACTION@$CURRENT_VER|$ACTION@$LATEST_TAG|g" "$workflow"

                    UPDATED=true
                    UPDATES_LOG="${UPDATES_LOG}\n  - $ACTION: $CURRENT_VER â†’ $LATEST_TAG"
                  else
                    echo "    âš ï¸  Major version change detected ($CURRENT_VER â†’ $LATEST_TAG), skipping"
                  fi
                else
                  echo "    âœ… Already up-to-date"
                fi
              fi
            done
          done

          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          if [ "$UPDATED" = true ]; then
            echo "âœ¨ GitHub Actions updated successfully!"
            echo -e "$UPDATES_LOG"
            echo "workflows_updated=true" >> $GITHUB_ENV
          else
            echo "âœ… All GitHub Actions are up-to-date"
            echo "workflows_updated=false" >> $GITHUB_ENV
          fi

          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      # =============================================================================
      # RUST DEPENDENCIES UPDATE
      # =============================================================================
      - name: Check current versions
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“¦ Current Rust dependency versions:"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          cargo tree --depth 1 || true
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: Update dependencies
        run: |
          echo "ğŸ”„ Updating Cargo.lock..."
          cargo update

          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“¦ Updated dependency tree:"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          cargo tree --depth 1 || true
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: Security audit
        run: |
          echo "ğŸ”’ Running security audit..."
          cargo +stable install cargo-audit --locked
          cargo +stable audit

      - name: Dependency policy (cargo-deny)
        run: |
          echo "ğŸ›¡ï¸  Checking dependency policies..."
          cargo +stable install cargo-deny --locked
          cargo +stable deny check all

      - name: Format check
        run: |
          echo "ğŸ¨ Checking code formatting..."
          cargo fmt --all -- --check

      - name: Build project
        run: |
          echo "ğŸ”¨ Building with updated dependencies..."
          cargo build --profile dev --locked
          cargo build --profile release --locked

          echo ""
          echo "âœ… Build successful with updated deps"

      - name: Run tests
        run: |
          echo "ğŸ§ª Running test suite..."
          cargo test --all --locked

          echo ""
          echo "âœ… All tests passed"
        continue-on-error: ${{ env.FORCE_UPDATE == 'true' }}

      - name: Quick clippy check
        run: |
          echo "ğŸ” Running clippy sanity check..."
          cargo clippy --locked --all-targets --all-features -- -D warnings

      - name: Configure Git (Nebula identity)
        run: |
          echo "âš™ï¸  Configuring Git as Nebula..."
          git config --global user.name "oxyzenQ[Nebula]"
          git config --global user.email "${{ secrets.GIT_EMAIL }}"

          echo "âœ… Git configured with Nebula identity"

      - name: Check for changes
        id: check_changes
        run: |
          if [[ -z "$(git status --porcelain)" ]]; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "âœ… No updates needed"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "ğŸ“ Updates detected"
            echo ""
            echo "Changed files:"
            git status --porcelain
            echo ""
            echo "Diff stat:"
            git diff --stat
          fi

      - name: Generate commit message
        id: commit_msg
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          WORKFLOW_UPDATED="${{ env.workflows_updated }}"

          if [ "$WORKFLOW_UPDATED" = "true" ]; then
            TITLE="chore: auto-update dependencies & workflows"
            BODY="ğŸŒŒ Automated update by Nebula

ğŸ“¦ Rust Dependencies
- Updated via cargo update
- Security audit passed
- All tests passed

ğŸ”„ GitHub Actions
- Auto-updated workflow versions
- Ensured compatibility (same major version only)

ğŸ›¡ï¸ Validation
- âœ… Security audit (cargo-audit)
- âœ… Dependency policy (cargo-deny)
- âœ… Code formatting
- âœ… Build check (dev + release)
- âœ… Test suite
- âœ… Clippy check"
          else
            TITLE="chore(deps): auto-update dependencies"
            BODY="ğŸŒŒ Automated update by Nebula

ğŸ“¦ Rust Dependencies
- Updated via cargo update
- Security audit passed
- All tests passed

ğŸ›¡ï¸ Validation
- âœ… Security audit (cargo-audit)
- âœ… Dependency policy (cargo-deny)
- âœ… Code formatting
- âœ… Build check (dev + release)
- âœ… Test suite
- âœ… Clippy check"
          fi

          echo "title=$TITLE" >> $GITHUB_OUTPUT
          {
            echo "body<<EOF"
            echo "$BODY"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Commit and push changes
        if: steps.check_changes.outputs.changed == 'true' && env.UPDATE_STRATEGY == 'direct'
        run: |
          git add -A

          git commit -s \
            -m "${{ steps.commit_msg.outputs.title }}" \
            -m "" \
            -m "${{ steps.commit_msg.outputs.body }}"

          git push origin main

          echo ""
          echo "âœ… Updates pushed to main"
          echo "ğŸ“ Commit: $(git rev-parse HEAD)"

      - name: Create pull request
        id: cpr
        if: steps.check_changes.outputs.changed == 'true' && env.UPDATE_STRATEGY == 'pr'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.NEBULA_TOKEN }}
          commit-message: "${{ steps.commit_msg.outputs.title }}"
          title: "${{ steps.commit_msg.outputs.title }}"
          body: "${{ steps.commit_msg.outputs.body }}"
          branch: bot/nebula-auto-update
          delete-branch: true
          signoff: true
          labels: |
            dependencies
            automated
          committer: oxyzenQ[Nebula] <${{ secrets.GIT_EMAIL }}>
          author: oxyzenQ[Nebula] <${{ secrets.GIT_EMAIL }}>

      - name: Summary
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸŒŒ NEBULA - UPDATE SUMMARY"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Strategy: ${{ env.UPDATE_STRATEGY }}"
          echo "Workflow Updates: ${{ env.UPDATE_WORKFLOWS }}"
          echo ""

          if [ "${{ steps.check_changes.outputs.changed }}" == "true" ]; then
            echo "âœ¨ Updates Applied:"

            if [ "${{ env.workflows_updated }}" == "true" ]; then
              echo "  - ğŸ”„ GitHub Actions updated"
            fi
            echo "  - ğŸ“¦ Rust dependencies updated"
            echo "  - ğŸ”’ Security audit passed"
            echo "  - ğŸ§ª Tests validated"
            echo ""

            if [ "${{ env.UPDATE_STRATEGY }}" == "direct" ]; then
              echo "âœ… Changes pushed to main"
              echo "ğŸ“ Commit: $(git rev-parse HEAD)"
            else
              echo "âœ… Pull request created"
              echo "ğŸ”— PR: ${{ steps.cpr.outputs.pull-request-url }}"
            fi
          else
            echo "âœ… No updates needed - everything is current!"
          fi

          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "â° Next run: 01:00 UTC (08:00 WIB)"
          echo "ğŸš€ Manual trigger: Actions â†’ Auto Update Dependencies"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
