name: T-800 - CI

'on':
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

permissions:
  contents: read

jobs:
  security:
    name: T-800 - Security audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4.3.1

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.81.0

      - name: Install stable toolchain
        run: rustup toolchain install stable

      - name: Setup cache
        uses: Swatinem/rust-cache@v2.8.2
        with:
          cache-on-failure: true

      - name: Audit dependencies
        shell: bash
        run: |
          set -euo pipefail
          cargo +stable install cargo-audit --locked
          cargo +stable audit

  msrv:
    name: T-800 - MSRV (Rust 1.81.0)
    runs-on: ubuntu-latest
    needs: security
    steps:
      - name: Checkout
        uses: actions/checkout@v4.3.1

      - name: Install Rust toolchain (MSRV)
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.81.0

      - name: Setup cache
        uses: Swatinem/rust-cache@v2.8.2
        with:
          cache-on-failure: true

      - name: Tests (MSRV)
        run: cargo test --all --locked

  build_test:
    name: T-800 - Test + Build (debug)
    runs-on: ubuntu-latest
    needs: [security, msrv]
    steps:
      - name: Checkout
        uses: actions/checkout@v4.3.1

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.81.0
          components: rustfmt, clippy

      - name: Setup cache
        uses: Swatinem/rust-cache@v2.8.2
        with:
          cache-on-failure: true

      - name: Set cargo build jobs
        shell: bash
        run: |
          set -euo pipefail
          JOBS="$(getconf _NPROCESSORS_ONLN 2>/dev/null || true)"
          if [[ -z "${JOBS}" ]]; then
            JOBS="$(nproc 2>/dev/null || true)"
          fi
          if [[ -z "${JOBS}" ]]; then
            JOBS="$(sysctl -n hw.ncpu 2>/dev/null || true)"
          fi
          if [[ -z "${JOBS}" ]]; then
            JOBS=2
          fi
          echo "CARGO_BUILD_JOBS=${JOBS}" >> "$GITHUB_ENV"

      - name: Tests
        run: cargo test --all --locked

      - name: Build (debug)
        run: cargo build --profile dev --locked --jobs "${CARGO_BUILD_JOBS}"

  macos_build:
    name: T-800 - Build (macos native)
    runs-on: ${{ matrix.os }}
    needs: build_test
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            target: aarch64-apple-darwin
            profile: pro-macos-aarch64-native
            build: darwin-aarch64-native
    steps:
      - name: Checkout
        uses: actions/checkout@v4.3.1

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.81.0

      - name: Setup cache
        uses: Swatinem/rust-cache@v2.8.2
        with:
          cache-on-failure: true

      - name: Set cargo build jobs
        shell: bash
        run: |
          set -euo pipefail
          JOBS="$(getconf _NPROCESSORS_ONLN 2>/dev/null || true)"
          if [[ -z "${JOBS}" ]]; then
            JOBS="$(nproc 2>/dev/null || true)"
          fi
          if [[ -z "${JOBS}" ]]; then
            JOBS="$(sysctl -n hw.ncpu 2>/dev/null || true)"
          fi
          if [[ -z "${JOBS}" ]]; then
            JOBS=2
          fi
          echo "CARGO_BUILD_JOBS=${JOBS}" >> "$GITHUB_ENV"

      - name: Add Rust target
        run: rustup target add ${{ matrix.target }}

      - name: Build
        env:
          RUSTFLAGS: "-C target-cpu=native"
          COSMOSTRIX_BUILD: ${{ matrix.build }}
        run: cargo build --profile ${{ matrix.profile }} --locked --target ${{ matrix.target }} --jobs "${CARGO_BUILD_JOBS}"

      - name: Verify build id
        shell: bash
        run: |
          set -euo pipefail
          BIN="target/${{ matrix.target }}/${{ matrix.profile }}/cosmostrix"
          BUILD_ID="${{ matrix.build }}"
          OUT="$(${BIN} -i)"
          echo "${OUT}"
          echo "${OUT}" | grep -E "^(build|Build): ${BUILD_ID}( \\([0-9a-f]+\\))?$"

  android_build:
    name: T-800 - Build (android-aarch64)
    runs-on: ubuntu-latest
    needs: build_test
    if: github.event_name == 'push'
    steps:
      - name: Checkout
        uses: actions/checkout@v4.3.1

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.81.0

      - name: Setup cache
        uses: Swatinem/rust-cache@v2.8.2
        with:
          cache-on-failure: true

      - name: Set cargo build jobs
        shell: bash
        run: |
          set -euo pipefail
          JOBS="$(getconf _NPROCESSORS_ONLN 2>/dev/null || true)"
          if [[ -z "${JOBS}" ]]; then
            JOBS="$(nproc 2>/dev/null || true)"
          fi
          if [[ -z "${JOBS}" ]]; then
            JOBS="$(sysctl -n hw.ncpu 2>/dev/null || true)"
          fi
          if [[ -z "${JOBS}" ]]; then
            JOBS=2
          fi
          echo "CARGO_BUILD_JOBS=${JOBS}" >> "$GITHUB_ENV"

      - name: Setup Java
        uses: actions/setup-java@v4.8.0
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Android NDK
        id: ndk
        uses: nttld/setup-ndk@v1.5.0
        with:
          ndk-version: r26d

      - name: Add Rust target
        run: rustup target add aarch64-linux-android

      - name: Build (android-aarch64)
        shell: bash
        env:
          ANDROID_NDK_HOME: ${{ steps.ndk.outputs.ndk-path }}
          COSMOSTRIX_BUILD: android-aarch64-native
        run: |
          set -euo pipefail
          TARGET="aarch64-linux-android"

          TOOLCHAIN="${ANDROID_NDK_HOME}/toolchains/llvm/prebuilt/linux-x86_64"
          export CC_aarch64_linux_android="${TOOLCHAIN}/bin/aarch64-linux-android21-clang"
          export CARGO_TARGET_AARCH64_LINUX_ANDROID_LINKER="${CC_aarch64_linux_android}"

          cargo build --profile pro-android-aarch64 --locked --target "${TARGET}" --jobs "${CARGO_BUILD_JOBS}"

      - name: Verify build id
        shell: bash
        run: |
          set -euo pipefail
          BIN="target/aarch64-linux-android/pro-android-aarch64/cosmostrix"
          BUILD_ID="android-aarch64-native"
          echo "Verifying embedded build id in binary: ${BUILD_ID}"
          if command -v strings >/dev/null 2>&1; then
            strings "${BIN}" | grep -F "${BUILD_ID}"
          else
            grep -aF "${BUILD_ID}" "${BIN}"
          fi

  linux_aarch64_build:
    name: T-800 - Build (linux aarch64)
    runs-on: ubuntu-latest
    needs: build_test
    steps:
      - name: Checkout
        uses: actions/checkout@v4.3.1

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.81.0

      - name: Setup cache
        uses: Swatinem/rust-cache@v2.8.2
        with:
          cache-on-failure: true

      - name: Set cargo build jobs
        shell: bash
        run: |
          set -euo pipefail
          JOBS="$(getconf _NPROCESSORS_ONLN 2>/dev/null || true)"
          if [[ -z "${JOBS}" ]]; then
            JOBS="$(nproc 2>/dev/null || true)"
          fi
          if [[ -z "${JOBS}" ]]; then
            JOBS="$(sysctl -n hw.ncpu 2>/dev/null || true)"
          fi
          if [[ -z "${JOBS}" ]]; then
            JOBS=2
          fi
          echo "CARGO_BUILD_JOBS=${JOBS}" >> "$GITHUB_ENV"

      - name: Install Linux aarch64 linker
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu

      - name: Add Rust target
        run: rustup target add aarch64-unknown-linux-gnu

      - name: Build
        env:
          CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER: aarch64-linux-gnu-gcc
          COSMOSTRIX_BUILD: linux-aarch64-native
        run: cargo build --profile pro --locked --target aarch64-unknown-linux-gnu --jobs "${CARGO_BUILD_JOBS}"

      - name: Verify build id
        shell: bash
        run: |
          set -euo pipefail
          BIN="target/aarch64-unknown-linux-gnu/pro/cosmostrix"
          BUILD_ID="linux-aarch64-native"
          echo "Verifying embedded build id in binary: ${BUILD_ID}"
          if command -v strings >/dev/null 2>&1; then
            strings "${BIN}" | grep -F "${BUILD_ID}"
          else
            grep -aF "${BUILD_ID}" "${BIN}"
          fi

  windows_aarch64_build:
    name: T-800 - Build (windows aarch64)
    runs-on: windows-latest
    needs: windows_build
    steps:
      - name: Checkout
        uses: actions/checkout@v4.3.1

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.81.0

      - name: Setup cache
        uses: Swatinem/rust-cache@v2.8.2
        with:
          cache-on-failure: true

      - name: Set cargo build jobs
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $jobs = $env:NUMBER_OF_PROCESSORS
          if (-not $jobs) { $jobs = 2 }
          "CARGO_BUILD_JOBS=$jobs" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

      - name: Add Rust target
        run: rustup target add aarch64-pc-windows-msvc

      - name: Setup MSVC dev cmd
        uses: ilammy/msvc-dev-cmd@v1.13.0
        with:
          arch: amd64_arm64

      - name: Build
        shell: pwsh
        env:
          COSMOSTRIX_BUILD: windows-aarch64-native
        run: cargo build --profile pro --locked --target aarch64-pc-windows-msvc --jobs "$env:CARGO_BUILD_JOBS"

      - name: Verify build id
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $bin = "target/aarch64-pc-windows-msvc/pro/cosmostrix.exe"
          $build = "windows-aarch64-native"
          Write-Host "Verifying embedded build id in binary: $build"
          $bytes = [System.IO.File]::ReadAllBytes($bin)
          $text = [System.Text.Encoding]::ASCII.GetString($bytes)
          if (-not $text.Contains($build)) {
            throw "Expected embedded build id '$build' in binary"
          }

  linux_cpu_variants:
    name: T-800 - Build (linux x86_64 variants)
    runs-on: ubuntu-latest
    needs: build_test
    strategy:
      fail-fast: false
      matrix:
        include:
          - profile: pro-linux-v1
            rustflags: "-C target-cpu=x86-64"
            build: linux-x86_64-v1
          - profile: pro-linux-v2
            rustflags: "-C target-cpu=x86-64-v2"
            build: linux-x86_64-v2
          - profile: pro-linux-v3
            rustflags: "-C target-cpu=x86-64-v3"
            build: linux-x86_64-v3
          - profile: pro-linux-v4
            rustflags: "-C target-cpu=x86-64-v4"
            build: linux-x86_64-v4
    steps:
      - name: Checkout
        uses: actions/checkout@v4.3.1

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.81.0

      - name: Setup cache
        uses: Swatinem/rust-cache@v2.8.2
        with:
          cache-on-failure: true

      - name: Set cargo build jobs
        shell: bash
        run: |
          set -euo pipefail
          JOBS="$(getconf _NPROCESSORS_ONLN 2>/dev/null || true)"
          if [[ -z "${JOBS}" ]]; then
            JOBS="$(nproc 2>/dev/null || true)"
          fi
          if [[ -z "${JOBS}" ]]; then
            JOBS="$(sysctl -n hw.ncpu 2>/dev/null || true)"
          fi
          if [[ -z "${JOBS}" ]]; then
            JOBS=2
          fi
          echo "CARGO_BUILD_JOBS=${JOBS}" >> "$GITHUB_ENV"

      - name: Build
        env:
          RUSTFLAGS: ${{ matrix.rustflags }}
          COSMOSTRIX_BUILD: ${{ matrix.build }}
        run: cargo build --profile ${{ matrix.profile }} --locked --target x86_64-unknown-linux-gnu --jobs "${CARGO_BUILD_JOBS}"

  windows_cpu_variants:
    name: T-800 - Build (windows x86_64 variants)
    runs-on: windows-latest
    needs: windows_build
    strategy:
      fail-fast: false
      matrix:
        include:
          - profile: pro-win-v1
            rustflags: "-C target-cpu=x86-64"
          - profile: pro-win-v2
            rustflags: "-C target-cpu=x86-64-v2"
          - profile: pro-win-v3
            rustflags: "-C target-cpu=x86-64-v3"
          - profile: pro-win-v4
            rustflags: "-C target-cpu=x86-64-v4"
          - profile: pro-win-native
            rustflags: "-C target-cpu=native"
    steps:
      - name: Checkout
        uses: actions/checkout@v4.3.1

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.81.0

      - name: Setup cache
        uses: Swatinem/rust-cache@v2.8.2
        with:
          cache-on-failure: true

      - name: Set cargo build jobs
        shell: pwsh
        run: |
          set -euo pipefail
          BIN="target/x86_64-unknown-linux-gnu/${{ matrix.profile }}/cosmostrix"
          BUILD_ID="${{ matrix.build }}"

          if [[ "${BUILD_ID}" == *-v4 ]]; then
            echo "Skipping execution for ${BUILD_ID} (may require AVX-512); verifying embedded build id in binary"
            if command -v strings >/dev/null 2>&1; then
              strings "${BIN}" | grep -F "${BUILD_ID}"
            else
              grep -aF "${BUILD_ID}" "${BIN}"
            fi
          else
            OUT="$(${BIN} -i)"
            echo "${OUT}"
            echo "${OUT}" | grep -E "^(build|Build): ${BUILD_ID}( \\([0-9a-f]+\\))?$"
          fi

  windows_build:
    name: T-800 - Build (windows)
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4.3.1

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.81.0

      - name: Setup cache
        uses: Swatinem/rust-cache@v2.8.2
        with:
          cache-on-failure: true

      - name: Set cargo build jobs
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $jobs = $env:NUMBER_OF_PROCESSORS
          if (-not $jobs) { $jobs = 2 }
          "CARGO_BUILD_JOBS=$jobs" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

      - name: Build (debug)
        shell: pwsh
        run: cargo build --profile dev --locked --jobs "$env:CARGO_BUILD_JOBS"

      - name: Build (release)
        shell: pwsh
        env:
          COSMOSTRIX_BUILD: windows-x86_64
          RUSTFLAGS: "-C target-cpu=x86-64"
        run: cargo build --profile pro-win-x86_64 --locked --target x86_64-pc-windows-msvc --jobs "$env:CARGO_BUILD_JOBS"

      - name: Verify build id
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $bin = "target/x86_64-pc-windows-msvc/pro-win-x86_64/cosmostrix.exe"
          $build = "windows-x86_64"
          $outLines = & $bin -i
          $out = ($outLines | ForEach-Object { $_.TrimEnd("`r") }) -join "`n"
          $out
          $pat = "(?m)^(build|Build): " + [regex]::Escape($build) + "( \([0-9a-f]+\))?\s*$"
          if ($out -notmatch $pat) {
            throw "Expected build id '$build' in cosmostrix -i output"
          }

  fmt_clippy:
    name: T-800 - Format + Clippy
    runs-on: ubuntu-latest
    needs: build_test
    steps:
      - name: Checkout
        uses: actions/checkout@v4.3.1

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.81.0
          components: rustfmt, clippy

      - name: Setup cache
        uses: Swatinem/rust-cache@v2.8.2
        with:
          cache-on-failure: true

      - name: Format check
        run: cargo fmt --all -- --check

      - name: Clippy
        run: cargo clippy --locked --all-targets --all-features -- -D warnings

  deny:
    name: T-800 - Dependency policy (cargo-deny)
    runs-on: ubuntu-latest
    needs: build_test
    steps:
      - name: Checkout
        uses: actions/checkout@v4.3.1

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.81.0

      - name: Install stable toolchain
        run: rustup toolchain install stable

      - name: Setup cache
        uses: Swatinem/rust-cache@v2.8.2
        with:
          cache-on-failure: true

      - name: Install cargo-deny
        run: cargo +stable install cargo-deny --locked

      - name: cargo deny
        run: cargo +stable deny check all

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
